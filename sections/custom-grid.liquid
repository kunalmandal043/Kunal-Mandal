{{ 'custom-grid.css' | asset_url | stylesheet_tag }}


{% schema %}
{
  "name": "Custom Grid",
  "settings": [],
  "blocks": [
    {
      "type": "product",
      "name": "Product",
      "settings": [
        { "type": "product", "id": "product", "label": "Select Product" }
      ]
    }
  ],
  "max_blocks": 6,
  "presets": [{ "name": "Custom Grid" }]
}
{% endschema %}

<section class="custom-grid">
  <h2>Tisso vison in the wild</h2>
  <div class="grid-container">
    {% for block in section.blocks %}
      {% assign product = all_products[block.settings.product] %}
      {% if product %}
        <div class="grid-item" data-handle="{{ product.handle }}">
          {% if product.featured_image %}
            <img
              src="{{ product.featured_image | img_url: '600x' }}"
              alt="{{ product.title | escape }}"
              width="{{ product.featured_image.width }}"
              height="{{ product.featured_image.height }}"
              loading="lazy"
            >
          {% endif %}
          <p>{{ product.title }}</p>
        </div>
      {% endif %}
    {% endfor %}
  </div>
</section>

<!-- Product Popup -->
<div id="product-popup" class="popup hidden">
  <div class="popup-content">
    <span id="popup-close">&times;</span>
    <img id="popup-image" 
      src="{{ 'placeholder.png' | asset_url }}" 
      alt="Product preview" 
      width="400" height="400" loading="lazy">

    <h2 id="popup-title"></h2>
    <p id="popup-price"></p>
    <p id="popup-description"></p>

    <!-- Variants -->
    <label for="variant-select">Choose your options:</label>
    <select id="variant-select"></select>

    <!-- Add to Cart -->
    <button id="add-to-cart">ADD TO CART</button>
  </div>
</div>



<script>
document.addEventListener("DOMContentLoaded", () => {
  const gridItems = document.querySelectorAll(".grid-item");
  const popup = document.getElementById("product-popup");
  const popupClose = document.getElementById("popup-close");
  const popupImage = document.getElementById("popup-image");
  const popupTitle = document.getElementById("popup-title");
  const popupPrice = document.getElementById("popup-price");
  const popupDescription = document.getElementById("popup-description");
  const variantSelect = document.getElementById("variant-select");
  const addToCartBtn = document.getElementById("add-to-cart");

  let currentProduct = null;

  // Open popup when grid item is clicked
  gridItems.forEach(item => {
    item.addEventListener("click", async () => {
      const handle = item.dataset.handle;

      try {
        // Fetch product JSON
        const response = await fetch(`/products/${handle}.js`);
        const product = await response.json();
        currentProduct = product;

        // Fill popup content
        popupImage.src = product.images[0] || "{{ 'placeholder.png' | asset_url }}";
        popupTitle.textContent = product.title;
        popupPrice.textContent = formatMoney(product.price);
        popupDescription.textContent = product.description || "";

        // Populate variants
        variantSelect.innerHTML = "";
        product.variants.forEach(variant => {
          const option = document.createElement("option");
          option.value = variant.id;
          option.textContent = variant.title + " - " + formatMoney(variant.price);
          variantSelect.appendChild(option);
        });

        // Show popup
        popup.classList.remove("hidden");
      } catch (err) {
        console.error("Error loading product:", err);
      }
    });
  });

  // Close popup
  popupClose.addEventListener("click", () => {
    popup.classList.add("hidden");
  });
  popup.addEventListener("click", e => {
    if (e.target === popup) popup.classList.add("hidden"); // close when clicking outside
  });

  // Add to Cart
  addToCartBtn.addEventListener("click", async () => {
    if (!currentProduct) return;

    const selectedVariantId = variantSelect.value;
    const selectedVariant = currentProduct.variants.find(v => v.id == selectedVariantId);

    try {
      // Add selected variant
      await fetch("/cart/add.js", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: selectedVariantId, quantity: 1 })
      });

      // Special rule: If variant is Black + Medium â†’ add Soft Winter Jacket too
      if (selectedVariant.title.includes("Black") && selectedVariant.title.includes("Medium")) {
        const jacketResponse = await fetch(`/products/soft-winter-jacket.js`);
        const jacket = await jacketResponse.json();

        if (jacket.variants.length > 0) {
          const jacketVariantId = jacket.variants[0].id;
          await fetch("/cart/add.js", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: jacketVariantId, quantity: 1 })
          });
        }
      }

      alert("Product added to cart!");
      popup.classList.add("hidden");
    } catch (err) {
      console.error("Error adding to cart:", err);
      alert("Could not add product to cart.");
    }
  });

  // Format Shopify money
  function formatMoney(cents) {
    return (cents / 100).toLocaleString("en-US", {
      style: "currency",
      currency: "USD"
    });
  }
});
</script>
