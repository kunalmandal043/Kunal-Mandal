document.addEventListener("DOMContentLoaded", () => {
  const gridItems = document.querySelectorAll(".grid-item");
  const popup = document.getElementById("product-popup");
  const popupClose = document.getElementById("popup-close");
  const popupImage = document.getElementById("popup-image");
  const popupTitle = document.getElementById("popup-title");
  const popupPrice = document.getElementById("popup-price");
  const popupDescription = document.getElementById("popup-description");
  const variantSelect = document.getElementById("variant-select");
  const addToCartBtn = document.getElementById("add-to-cart");

  let currentProduct = null;

  // Open popup when grid item is clicked
  gridItems.forEach(item => {
    item.addEventListener("click", async () => {
      const handle = item.dataset.handle;

      try {
        // Fetch product JSON
        const response = await fetch(`/products/${handle}.js`);
        const product = await response.json();
        currentProduct = product;

        // Fill popup content
        popupImage.src = product.images[0] || "{{ 'placeholder.png' | asset_url }}";
        popupTitle.textContent = product.title;
        popupPrice.textContent = formatMoney(product.price);
        popupDescription.textContent = product.description || "";

        // Populate variants
        variantSelect.innerHTML = "";
        product.variants.forEach(variant => {
          const option = document.createElement("option");
          option.value = variant.id;
          option.textContent = variant.title + " - " + formatMoney(variant.price);
          variantSelect.appendChild(option);
        });

        // Show popup
        popup.classList.remove("hidden");
      } catch (err) {
        console.error("Error loading product:", err);
      }
    });
  });

  // Close popup
  popupClose.addEventListener("click", () => {
    popup.classList.add("hidden");
  });
  popup.addEventListener("click", e => {
    if (e.target === popup) popup.classList.add("hidden"); // close on outside click
  });

  // Add to Cart
  addToCartBtn.addEventListener("click", async () => {
    if (!currentProduct) return;

    const selectedVariantId = variantSelect.value;
    const selectedVariant = currentProduct.variants.find(v => v.id == selectedVariantId);

    try {
      // Add selected variant
      await fetch("/cart/add.js", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: selectedVariantId, quantity: 1 })
      });

      // Special rule: If variant is Black + Medium â†’ add Soft Winter Jacket too
      if (selectedVariant.title.includes("Black") && selectedVariant.title.includes("Medium")) {
        const jacketResponse = await fetch(`/products/soft-winter-jacket.js`);
        const jacket = await jacketResponse.json();

        if (jacket.variants.length > 0) {
          const jacketVariantId = jacket.variants[0].id;
          await fetch("/cart/add.js", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: jacketVariantId, quantity: 1 })
          });
        }
      }

      alert("Product added to cart!");
      popup.classList.add("hidden");
    } catch (err) {
      console.error("Error adding to cart:", err);
      alert("Could not add product to cart.");
    }
  });

  // Format Shopify money
  function formatMoney(cents) {
    return (cents / 100).toLocaleString("en-US", {
      style: "currency",
      currency: "USD"
    });
  }
});
