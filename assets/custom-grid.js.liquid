document.addEventListener("DOMContentLoaded", () => {
  const popup = document.getElementById("product-popup");
  const popupImage = document.getElementById("popup-image");
  const popupTitle = document.getElementById("popup-title");
  const popupPrice = document.getElementById("popup-price");
  const popupDescription = document.getElementById("popup-description");
  const variantSelect = document.getElementById("variant-select");
  const addToCartBtn = document.getElementById("add-to-cart");
  const popupClose = document.getElementById("popup-close");

  let currentProduct = null;

  // Click only on popup icon
  document.querySelectorAll(".grid-item .popup-icon").forEach(icon => {
    icon.addEventListener("click", async (e) => {
      e.stopPropagation(); // Prevent parent click events
      const gridItem = e.target.closest(".grid-item");
      const handle = gridItem.dataset.productHandle;

      try {
        // Fetch product JSON dynamically
        const res = await fetch(`/products/${handle}.js`);
        const product = await res.json();
        currentProduct = product;

        // Fill popup data
        popupImage.src = product.featured_image;
        popupTitle.textContent = product.title;
        popupPrice.textContent = formatMoney(product.price);
        popupDescription.textContent = product.description || "";

        // Populate variants
        variantSelect.innerHTML = "";
        product.variants.forEach(variant => {
          const option = document.createElement("option");
          option.value = variant.id;
          option.textContent = variant.title;
          variantSelect.appendChild(option);
        });

        // Show popup
        popup.classList.remove("hidden");

      } catch (error) {
        console.error("Error loading product:", error);
      }
    });
  });

  // Close popup
  popupClose.addEventListener("click", () => {
    popup.classList.add("hidden");
  });

  // Add to cart
  addToCartBtn.addEventListener("click", async () => {
    const variantId = variantSelect.value;
    if (!variantId) return;

    try {
      const res = await fetch("/cart/add.js", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify({ id: variantId, quantity: 1 })
      });

      if (!res.ok) throw new Error("Add to cart failed");

      alert("Product added to cart!");
      popup.classList.add("hidden");

    } catch (error) {
      console.error("Cart error:", error);
      alert("Could not add to cart.");
    }
  });

  // Format Shopify money
  function formatMoney(cents) {
    return new Intl.NumberFormat("en-IN", {
      style: "currency",
      currency: Shopify.currency.active
    }).format(cents / 100);
  }
});
