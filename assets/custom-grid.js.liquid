function initCustomGrid() {
  const gridItems = document.querySelectorAll(".grid-item");
  const popup = document.getElementById("product-popup");
  const popupClose = document.getElementById("popup-close");
  const popupImage = document.getElementById("popup-image");
  const popupTitle = document.getElementById("popup-title");
  const popupPrice = document.getElementById("popup-price");
  const popupDescription = document.getElementById("popup-description");
  const sizeSelect = document.getElementById("size-select");
  const addToCartBtn = document.getElementById("add-to-cart");
  const colorOptionContainer = document.getElementById("color-option-container");
  const colorOptionsWrapper = document.getElementById("color-options");

  let currentProduct = null;

  function formatMoney(cents) {
    return (cents / 100).toLocaleString("en-US", { style: "currency", currency: "USD" });
  }

  function findVariant(product, selectedOptions) {
    return product.variants.find(variant => {
      return variant.options.every((option, index) => selectedOptions[index] === option);
    });
  }

  function updatePrice() {
    if (!currentProduct) return;
    const selectedColor = colorOptionsWrapper.querySelector(".color-option.selected")?.dataset.value;
    const selectedSize = sizeSelect.value;
    const selectedOptions = [];

    currentProduct.options.forEach(option => {
      if (option.name.toLowerCase() === "color") {
        selectedOptions.push(selectedColor);
      } else if (option.name.toLowerCase() === "size") {
        selectedOptions.push(selectedSize);
      } else {
        selectedOptions.push(option.values[0]);
      }
    });

    const variant = findVariant(currentProduct, selectedOptions);
    if (variant) {
      popupPrice.textContent = formatMoney(parseFloat(variant.price) * 100);
    }
  }

  async function showProductPopup(handle) {
    if (!handle) return;
    try {
      const res = await fetch(`/products/${handle}.js`);
      const data = await res.json();
      currentProduct = data;

      popupImage.src = data.images.length > 0 ? data.images[0] : "{{ 'placeholder.png' | asset_url }}";
      popupTitle.textContent = data.title;
      if (data.variants.length > 0) {
        popupPrice.textContent = formatMoney(parseFloat(data.variants[0].price) * 100);
      }
      popupDescription.innerHTML = data.description || "";

      sizeSelect.innerHTML = "";
      colorOptionsWrapper.innerHTML = "";
      colorOptionContainer.style.display = "none";

      if (data.options) {
        data.options.forEach(option => {
          if (option.name.toLowerCase() === "size") {
            option.values.forEach(val => {
              const opt = document.createElement("option");
              opt.value = val;
              opt.textContent = val;
              sizeSelect.appendChild(opt);
            });
          } else if (option.name.toLowerCase() === "color") {
            colorOptionContainer.style.display = "block";
            option.values.forEach(val => {
              const div = document.createElement("div");
              div.className = "color-option";
              div.textContent = val;
              div.dataset.value = val;

              // Color map
              const colorMap = {
                black: "#000000",
                red: "#FF0000",
                blue: "#0000FF",
                white: "#FFFFFF",
                green: "#008000",
                yellow: "#FFFF00",
                gray: "#808080"
              };
              const swatchColor = colorMap[val.toLowerCase()] || "#ccc";
              div.style.setProperty("--swatch-color", swatchColor);

              div.addEventListener("click", () => {
                colorOptionsWrapper.querySelectorAll(".color-option").forEach(el => el.classList.remove("selected"));
                div.classList.add("selected");
                updatePrice();
              });

              colorOptionsWrapper.appendChild(div);
            });
          }
        });
      }

      sizeSelect.addEventListener("change", updatePrice);

      popup.classList.remove("hidden");
      document.body.style.overflow = "hidden";
    } catch (err) {
      console.error("Error loading product:", err);
    }
  }

  gridItems.forEach(item => {
    const popupIcon = item.querySelector(".popup-icon");
    if (!popupIcon) return;
    popupIcon.addEventListener("click", e => {
      e.stopPropagation();
      const handle = item.dataset.handle;
      showProductPopup(handle);
    });
  });

  popupClose.addEventListener("click", () => {
    popup.classList.add("hidden");
    document.body.style.overflow = "";
  });

  popup.addEventListener("click", e => {
    if (e.target === popup) {
      popup.classList.add("hidden");
      document.body.style.overflow = "";
    }
  });

  addToCartBtn.addEventListener("click", async () => {
    if (!currentProduct) return;

    const selectedColor = colorOptionsWrapper.querySelector(".color-option.selected")?.dataset.value;
    const selectedSize = sizeSelect.value;
    const selectedOptions = [];

    currentProduct.options.forEach(option => {
      if (option.name.toLowerCase() === "color") {
        selectedOptions.push(selectedColor);
      } else if (option.name.toLowerCase() === "size") {
        selectedOptions.push(selectedSize);
      } else {
        selectedOptions.push(option.values[0]);
      }
    });

    const variant = findVariant(currentProduct, selectedOptions);
    if (!variant) {
      alert("Please select valid options");
      return;
    }

    try {
      addToCartBtn.disabled = true;
      addToCartBtn.querySelector("span").textContent = "Adding...";

      const response = await fetch("/cart/add.js", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: variant.id, quantity: 1 })
      });

      if (response.ok) {
        alert("Product added to cart!");
        popup.classList.add("hidden");
        document.body.style.overflow = "";
      } else {
        throw new Error("Failed to add to cart");
      }
    } catch (err) {
      console.error(err);
      alert("Could not add product to cart.");
    } finally {
      addToCartBtn.disabled = false;
      addToCartBtn.querySelector("span").textContent = "ADD TO CART âžœ";
    }
  });
}

if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", initCustomGrid);
} else {
  initCustomGrid();
}
