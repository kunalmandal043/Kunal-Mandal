const gridItems = document.querySelectorAll(".grid-item");
const popup = document.getElementById("product-popup");
const popupClose = document.getElementById("popup-close");
const popupImage = document.getElementById("popup-image");
const popupTitle = document.getElementById("popup-title");
const popupPrice = document.getElementById("popup-price");
const popupDescription = document.getElementById("popup-description");
const sizeSelect = document.getElementById("size-select");
const colorSelect = document.getElementById("color-select");
const addToCartBtn = document.getElementById("add-to-cart");

let currentProduct = null;

gridItems.forEach(item => {
  const icon = item.querySelector(".popup-icon");

  icon.addEventListener("click", async (e) => {
    e.stopPropagation();
    const handle = item.dataset.handle;

    try {
      const response = await fetch(`/products/${handle}.js`);
      const product = await response.json();
      currentProduct = product;

      popupImage.src = product.images[0] || "/assets/placeholder.png";
      popupTitle.textContent = product.title;
      popupPrice.textContent = formatMoney(product.price);
      popupDescription.innerHTML = product.description;

      // Populate size
      sizeSelect.innerHTML = "";
      const sizeValues = product.options.find(o => o.name.toLowerCase() === "size")?.values || [];
      sizeValues.forEach(s => {
        const option = document.createElement("option");
        option.value = s;
        option.textContent = s;
        sizeSelect.appendChild(option);
      });

      // Populate color
      colorSelect.innerHTML = "";
      const colorValues = product.options.find(o => o.name.toLowerCase() === "color")?.values || [];
      colorValues.forEach(c => {
        const option = document.createElement("option");
        option.value = c;
        option.textContent = c;
        colorSelect.appendChild(option);
      });

      popup.classList.remove("hidden");
    } catch (err) {
      console.error("Failed to fetch product:", err);
    }
  });
});

// Close popup
popupClose.addEventListener("click", () => popup.classList.add("hidden"));
popup.addEventListener("click", e => { if(e.target === popup) popup.classList.add("hidden"); });

// Add to cart
addToCartBtn.addEventListener("click", async () => {
  if (!currentProduct) return;

  const selectedSize = sizeSelect.value;
  const selectedColor = colorSelect.value;

  const variant = currentProduct.variants.find(v =>
    v.option1 === selectedSize && v.option2 === selectedColor
  );

  if (!variant) {
    alert("Variant not found.");
    return;
  }

  try {
    await fetch("/cart/add.js", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id: variant.id, quantity: 1 })
    });
    alert("Product added to cart!");
    popup.classList.add("hidden");
  } catch (err) {
    console.error(err);
    alert("Could not add product to cart.");
  }
});

// Format money
function formatMoney(cents) {
  return (cents / 100).toLocaleString("en-US", { style: "currency", currency: "USD" });
}
