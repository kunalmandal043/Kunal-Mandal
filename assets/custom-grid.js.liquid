// custom-grid.js
function initCustomGrid() {
  const gridItems = document.querySelectorAll(".grid-item");
  const popup = document.getElementById("product-popup");
  const popupClose = document.getElementById("popup-close");
  const popupImage = document.getElementById("popup-image");
  const popupTitle = document.getElementById("popup-title");
  const popupPrice = document.getElementById("popup-price");
  const popupDescription = document.getElementById("popup-description");
  const sizeSelect = document.getElementById("size-select");
  const addToCartBtn = document.getElementById("add-to-cart");
  const colorOptionContainer = document.getElementById("color-option-container");
  const sizeOptionContainer = document.getElementById("size-option-container");
  const colorSwatches = document.getElementById("color-swatches");

  let currentProduct = null;
  let selectedColor = null;

  // Format money function
  function formatMoney(cents) {
    return (cents / 100).toLocaleString("en-US", { 
      style: "currency", 
      currency: "USD" 
    });
  }

  // Find variant based on selected options
  function findVariant(product, selectedOptions) {
    return product.variants.find(variant => {
      return variant.options.every((option, index) => {
        return selectedOptions[index] === option;
      });
    });
  }

  // Update cart count in header
  function updateCartCount() {
    fetch('/cart.js')
      .then(response => response.json())
      .then(cart => {
        // Update all cart count elements
        const cartCounts = document.querySelectorAll('.cart-count, [data-cart-count], #cart-count');
        cartCounts.forEach(element => {
          element.textContent = cart.item_count;
        });
        
        // Dispatch event for other parts of the theme
        document.dispatchEvent(new CustomEvent('cart:updated', {
          detail: {
            cart: cart
          }
        }));
      })
      .catch(error => {
        console.error('Error updating cart count:', error);
      });
  }

  // Update price when options change
  function updatePrice() {
    if (!currentProduct) return;
    
    const selectedSize = sizeSelect.value;
    
    // Create options array in the correct order
    const selectedOptions = [];
    currentProduct.options.forEach(option => {
      if (option.name.toLowerCase() === "color") {
        selectedOptions.push(selectedColor || option.values[0]);
      } else if (option.name.toLowerCase() === "size") {
        selectedOptions.push(selectedSize || option.values[0]);
      } else {
        // For other options, use the first available value
        selectedOptions.push(option.values[0]);
      }
    });
    
    const variant = findVariant(currentProduct, selectedOptions);
    if (variant) {
      popupPrice.textContent = formatMoney(parseFloat(variant.price) * 100);
    }
  }

  // Function to show product popup
  async function showProductPopup(handle) {
    if (!handle) return;

    try {
      const res = await fetch(`/products/${handle}.js`);
      const data = await res.json();
      currentProduct = data;
      
      // Set image
      popupImage.src = data.images && data.images.length > 0 
        ? data.images[0] 
        : "{{ 'placeholder.png' | asset_url }}";
      popupImage.alt = data.title;

      // Set title, price, description
      popupTitle.textContent = data.title;
      
      // Use first variant's price initially
      if (data.variants && data.variants.length > 0) {
        popupPrice.textContent = formatMoney(parseFloat(data.variants[0].price) * 100);
      }
      
      popupDescription.innerHTML = data.description || "";

      // Clear previous options
      sizeSelect.innerHTML = "";
      colorSwatches.innerHTML = "";
      
      // Reset selected color
      selectedColor = null;
      
      // Hide option containers initially
      colorOptionContainer.style.display = 'none';
      sizeOptionContainer.style.display = 'none';

      // Populate options
      if (data.options) {
        data.options.forEach(option => {
          if (option.name.toLowerCase() === "size") {
            sizeOptionContainer.style.display = 'block';
            option.values.forEach(val => {
              const optionElement = document.createElement("option");
              optionElement.value = val;
              optionElement.textContent = val;
              sizeSelect.appendChild(optionElement);
            });
          } else if (option.name.toLowerCase() === "color") {
            colorOptionContainer.style.display = 'block';
            
            // Create color swatches instead of dropdown
            option.values.forEach(val => {
              const swatch = document.createElement("div");
              swatch.className = "color-swatch";
              swatch.dataset.value = val;
              swatch.title = val;
              
              // Try to create a color from the value
              const colorName = val.toLowerCase();
              let backgroundColor = "#ccc"; // Default gray
              
              // Map common color names to hex values
              const colorMap = {
                "red": "#ff0000",
                "blue": "#0000ff",
                "green": "#008000",
                "black": "#000000",
                "white": "#ffffff",
                "yellow": "#ffff00",
                "purple": "#800080",
                "pink": "#ffc0cb",
                "orange": "#ffa500",
                "gray": "#808080",
                "grey": "#808080",
                "brown": "#a52a2a",
                "navy": "#000080",
                "teal": "#008080",
                "olive": "#808000",
                "maroon": "#800000",
                "silver": "#c0c0c0",
                "gold": "#ffd700",
                "beige": "#f5f5dc",
                "cyan": "#00ffff",
                "magenta": "#ff00ff",
                "lavender": "#e6e6fa",
                "turquoise": "#40e0d0",
                "coral": "#ff7f50",
                "indigo": "#4b0082",
                "violet": "#ee82ee",
                "tan": "#d2b48c",
                "salmon": "#fa8072",
                "khaki": "#f0e68c",
                "plum": "#dda0dd",
                "orchid": "#da70d6",
                "azure": "#f0ffff",
                "mint": "#f5fffa",
                "ivory": "#fffff0",
                "wheat": "#f5deb3"
              };
              
              if (colorMap[colorName]) {
                backgroundColor = colorMap[colorName];
              } else if (val.startsWith("#") && val.length === 7) {
                // If it's already a hex code
                backgroundColor = val;
              }
              
              swatch.style.backgroundColor = backgroundColor;
              
              // Add border for light colors
              if (colorName === "white" || colorName === "beige" || colorName === "ivory" || 
                  colorName === "azure" || colorName === "mint" || colorName === "wheat") {
                swatch.style.border = "1px solid #ddd";
              }
              
              swatch.addEventListener("click", () => {
                // Remove selected class from all swatches
                document.querySelectorAll(".color-swatch").forEach(s => {
                  s.classList.remove("selected");
                });
                
                // Add selected class to clicked swatch
                swatch.classList.add("selected");
                
                // Update selected color
                selectedColor = val;
                
                // Update price
                updatePrice();
              });
              
              colorSwatches.appendChild(swatch);
            });
          }
        });
      }

      // Add event listeners for option changes
      sizeSelect.addEventListener('change', updatePrice);
      
      // Show popup
      popup.classList.remove("hidden");
      document.body.style.overflow = 'hidden'; // Prevent scrolling
    } catch (err) {
      console.error("Error loading product:", err);
    }
  }

  // Add event listeners to grid items
  gridItems.forEach(item => {
    const popupIcon = item.querySelector(".popup-icon");
    if (!popupIcon) return;

    popupIcon.addEventListener("click", (e) => {
      e.stopPropagation();
      const handle = item.dataset.handle;
      showProductPopup(handle);
    });
  });

  // Close popup
  popupClose.addEventListener("click", () => {
    popup.classList.add("hidden");
    document.body.style.overflow = ''; // Re-enable scrolling
  });
  
  popup.addEventListener("click", e => {
    if (e.target === popup) {
      popup.classList.add("hidden");
      document.body.style.overflow = ''; // Re-enable scrolling
    }
  });

  // Add to Cart
  addToCartBtn.addEventListener("click", async () => {
    if (!currentProduct) return;
    
    const selectedSize = sizeSelect.value;
    
    // Create options array in the correct order
    const selectedOptions = [];
    currentProduct.options.forEach(option => {
      if (option.name.toLowerCase() === "color") {
        selectedOptions.push(selectedColor || option.values[0]);
      } else if (option.name.toLowerCase() === "size") {
        selectedOptions.push(selectedSize || option.values[0]);
      } else {
        // For other options, use the first available value
        selectedOptions.push(option.values[0]);
      }
    });
    
    const variant = findVariant(currentProduct, selectedOptions);
    
    if (!variant) {
      alert("Please select valid options");
      return;
    }

    try {
      // Show loading state
      addToCartBtn.disabled = true;
      addToCartBtn.querySelector('span').textContent = 'Adding...';
      
      const response = await fetch("/cart/add.js", {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "X-Requested-With": "XMLHttpRequest"
        },
        body: JSON.stringify({ id: variant.id, quantity: 1 })
      });
      
      if (response.ok) {
        // Update cart count
        updateCartCount();
        
        alert("Product added to cart!");
        popup.classList.add("hidden");
        document.body.style.overflow = ''; // Re-enable scrolling
      } else {
        throw new Error('Failed to add to cart');
      }
    } catch (err) {
      console.error(err);
      alert("Could not add product to cart.");
    } finally {
      // Reset button state
      addToCartBtn.disabled = false;
      addToCartBtn.querySelector('span').textContent = 'ADD TO CART ➜';
    }
  });
}

// Initialize when DOM is loaded
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initCustomGrid);
} else {
  initCustomGrid();
}

// Reinitialize when Shopify's AJAX page loading completes
if (typeof Shopify !== 'undefined') {
  document.addEventListener('shopify:section:load', initCustomGrid);
}