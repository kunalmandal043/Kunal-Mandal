document.addEventListener("DOMContentLoaded", () => {
  const popup = document.getElementById("product-popup");
  const closeBtn = document.getElementById("popup-close");
  const popupImage = document.getElementById("popup-image");
  const popupTitle = document.getElementById("popup-title");
  const popupPrice = document.getElementById("popup-price");
  const popupDescription = document.getElementById("popup-description");
  const variantSelect = document.getElementById("variant-select");
  const addToCartBtn = document.getElementById("add-to-cart");

  let currentProduct = null;

  // Open popup on icon click
  document.querySelectorAll(".grid-item .popup-icon").forEach(icon => {
    icon.addEventListener("click", async (e) => {
      const item = e.target.closest(".grid-item");
      const handle = item.dataset.handle;

      // Fetch product JSON from Shopify
      const res = await fetch(`/products/${handle}.js`);
      const product = await res.json();
      currentProduct = product;

      // Populate popup
      popupImage.src = product.featured_image;
      popupTitle.textContent = product.title;
      popupPrice.textContent = (product.price / 100).toLocaleString("en-US", {style:"currency", currency:"USD"});
      popupDescription.textContent = product.description || "";

      // Fill variants
      variantSelect.innerHTML = "";
      product.variants.forEach(variant => {
        const option = document.createElement("option");
        option.value = variant.id;
        option.textContent = variant.title + " - " + (variant.price / 100).toLocaleString("en-US", {style:"currency", currency:"USD"});
        variantSelect.appendChild(option);
      });

      popup.classList.remove("hidden");
    });
  });

  // Close popup
  closeBtn.addEventListener("click", () => popup.classList.add("hidden"));

  // Add to Cart
  addToCartBtn.addEventListener("click", async () => {
    const variantId = variantSelect.value;
    if (!variantId) return;

    await fetch("/cart/add.js", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        id: variantId,
        quantity: 1
      })
    });

    alert("Added to cart!");
    popup.classList.add("hidden");
  });
});
